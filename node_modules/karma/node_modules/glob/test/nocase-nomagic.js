var fs = require('fs');
var test = require('tap').test;
var glob = require('../');

test('mock fs', function(t) {
  var stat = fs.stat
  var statSync = fs.statSync
  var readdir = fs.readdir
  var readdirSync = fs.readdirSync

  function fakeStat(path) {
    var ret
    switch (path.toLowerCase()) {
      case '/tmp': case '/tmp/':
<<<<<<< HEAD
	ret = { isDirectory: function() { return true } }
	break
      case '/tmp/a':
	ret = { isDirectory: function() { return false } }
	break
=======
        ret = { isDirectory: function() { return true } }
        break
      case '/tmp/a':
        ret = { isDirectory: function() { return false } }
        break
>>>>>>> 40dc066702148240d46d84f6c15203d8e58bc81e
    }
    return ret
  }

  fs.stat = function(path, cb) {
    var f = fakeStat(path);
    if (f) {
      process.nextTick(function() {
<<<<<<< HEAD
	cb(null, f)
=======
        cb(null, f)
>>>>>>> 40dc066702148240d46d84f6c15203d8e58bc81e
      })
    } else {
      stat.call(fs, path, cb)
    }
  }

  fs.statSync = function(path) {
    return fakeStat(path) || statSync.call(fs, path)
  }

  function fakeReaddir(path) {
    var ret
    switch (path.toLowerCase()) {
      case '/tmp': case '/tmp/':
<<<<<<< HEAD
	ret = [ 'a', 'A' ]
	break
      case '/':
	ret = ['tmp', 'tMp', 'tMP', 'TMP']
=======
        ret = [ 'a', 'A' ]
        break
      case '/':
        ret = ['tmp', 'tMp', 'tMP', 'TMP']
>>>>>>> 40dc066702148240d46d84f6c15203d8e58bc81e
    }
    return ret
  }

  fs.readdir = function(path, cb) {
    var f = fakeReaddir(path)
    if (f)
      process.nextTick(function() {
<<<<<<< HEAD
	cb(null, f)
=======
        cb(null, f)
>>>>>>> 40dc066702148240d46d84f6c15203d8e58bc81e
      })
    else
      readdir.call(fs, path, cb)
  }

  fs.readdirSync = function(path) {
    return fakeReaddir(path) || readdirSync.call(fs, path)
  }

  t.pass('mocked')
  t.end()
})

test('nocase, nomagic', function(t) {
  var n = 2
  var want = [ '/TMP/A',
<<<<<<< HEAD
	       '/TMP/a',
	       '/tMP/A',
	       '/tMP/a',
	       '/tMp/A',
	       '/tMp/a',
	       '/tmp/A',
	       '/tmp/a' ]
=======
               '/TMP/a',
               '/tMP/A',
               '/tMP/a',
               '/tMp/A',
               '/tMp/a',
               '/tmp/A',
               '/tmp/a' ]
>>>>>>> 40dc066702148240d46d84f6c15203d8e58bc81e
  glob('/tmp/a', { nocase: true }, function(er, res) {
    if (er)
      throw er
    t.same(res.sort(), want)
    if (--n === 0) t.end()
  })
  glob('/tmp/A', { nocase: true }, function(er, res) {
    if (er)
      throw er
    t.same(res.sort(), want)
    if (--n === 0) t.end()
  })
})

test('nocase, with some magic', function(t) {
  t.plan(2)
  var want = [ '/TMP/A',
<<<<<<< HEAD
	       '/TMP/a',
	       '/tMP/A',
	       '/tMP/a',
	       '/tMp/A',
	       '/tMp/a',
	       '/tmp/A',
	       '/tmp/a' ]
=======
               '/TMP/a',
               '/tMP/A',
               '/tMP/a',
               '/tMp/A',
               '/tMp/a',
               '/tmp/A',
               '/tmp/a' ]
>>>>>>> 40dc066702148240d46d84f6c15203d8e58bc81e
  glob('/tmp/*', { nocase: true }, function(er, res) {
    if (er)
      throw er
    t.same(res.sort(), want)
  })
  glob('/tmp/*', { nocase: true }, function(er, res) {
    if (er)
      throw er
    t.same(res.sort(), want)
  })
})
